<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä SalesMatch Pro Analytics Dashboard</title>
    <link rel="stylesheet" href="/css/styles-new.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞–¥–º–∏–Ω-–¥–∞—à–±–æ—Ä–¥–∞ */
        .admin-header {
            background: var(--glass-background);
            backdrop-filter: var(--glass-backdrop);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-medium);
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .admin-header::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, var(--gold), var(--primary-blue-light), var(--gold));
            border-radius: var(--border-radius-medium);
            opacity: 0.7;
            z-index: -1;
        }
        
        .admin-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 15px;
            background: linear-gradient(45deg, var(--gold), var(--gold-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .admin-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.3rem;
            margin-bottom: 20px;
        }
        
        .refresh-section {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric-highlight {
            position: relative;
        }
        
        .metric-highlight .metric-value {
            animation: pulseNumber 2s ease-in-out infinite;
        }
        
        @keyframes pulseNumber {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-healthy { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }
        
        .endpoints-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .endpoint-card {
            background: var(--glass-background);
            backdrop-filter: var(--glass-backdrop);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-small);
            padding: 15px;
            transition: all var(--transition-smooth);
        }
        
        .endpoint-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 215, 0, 0.2);
        }
        
        .endpoint-method {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .method-get { background: #10b981; color: white; }
        .method-post { background: #3b82f6; color: white; }
        
        .footer-info {
            margin-top: 40px;
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 58, 138, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 215, 0, 0.3);
            border-left: 4px solid var(--gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .admin-title { font-size: 2rem; }
            .admin-subtitle { font-size: 1.1rem; }
            .refresh-section { flex-direction: column; }
            .endpoints-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 20px; color: white;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
    </div>

    <div class="main-content">
        <!-- Header Section -->
        <div class="admin-header">
            <div class="admin-title">üìä Analytics Dashboard</div>
            <div class="admin-subtitle">SalesMatch Pro - –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</div>
            
            <div class="refresh-section">
                <button class="btn btn-gold" onclick="refreshMetrics()">
                    <i class="fas fa-sync-alt"></i>
                    –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                </button>
                <button class="btn btn-glass" onclick="toggleAutoRefresh()">
                    <i class="fas fa-clock" id="autoRefreshIcon"></i>
                    <span id="autoRefreshText">–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
                </button>
                <button class="btn btn-blue" onclick="downloadReport()">
                    <i class="fas fa-download"></i>
                    –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç
                </button>
            </div>
            
            <div style="margin-top: 15px;">
                <span class="status-indicator status-healthy" id="statusIndicator"></span>
                <span id="statusText">–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ</span>
                <span style="margin-left: 20px; color: rgba(255,255,255,0.6);" id="lastUpdate">
                    –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: --:--
                </span>
            </div>
        </div>

        <!-- Metrics Grid -->
        <div class="metrics-grid" id="metricsGrid">
            <!-- Metrics will be loaded here -->
        </div>

        <!-- API Endpoints Section -->
        <div class="glass-card">
            <h3>üîó API Endpoints</h3>
            <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">
                –î–æ—Å—Ç—É–ø–Ω—ã–µ endpoints –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
            </p>
            
            <div class="endpoints-grid">
                <div class="endpoint-card">
                    <div>
                        <span class="endpoint-method method-get">GET</span>
                        <code>/api/v1/analytics/admin/metrics</code>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                        –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                    </p>
                </div>
                
                <div class="endpoint-card">
                    <div>
                        <span class="endpoint-method method-get">GET</span>
                        <code>/api/v1/analytics/admin/weekly-report</code>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                        –ù–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –¥–ª—è Telegram
                    </p>
                </div>
                
                <div class="endpoint-card">
                    <div>
                        <span class="endpoint-method method-get">GET</span>
                        <code>/api/v1/analytics/admin/health</code>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                        –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–∏—Å—Ç–µ–º—ã
                    </p>
                </div>
                
                <div class="endpoint-card">
                    <div>
                        <span class="endpoint-method method-post">POST</span>
                        <code>/api/v1/analytics/track</code>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                        –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
                    </p>
                </div>
                
                <div class="endpoint-card">
                    <div>
                        <span class="endpoint-method method-get">GET</span>
                        <code>/api/v1/analytics/user/stats/:userId</code>
                    </div>
                    <p style="margin: 10px 0 0 0; font-size: 0.9rem; color: rgba(255,255,255,0.7);">
                        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Premium)
                    </p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-info">
            <p>
                <i class="fas fa-chart-line" style="color: var(--gold);"></i>
                SalesMatch Pro Analytics System
                <span style="margin: 0 10px;">‚Ä¢</span>
                Built with ‚ù§Ô∏è by Deep Fon Corporation
            </p>
            <p style="margin-top: 10px;">
                –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
            </p>
        </div>
    </div>

    <script>
        // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –°–û–°–¢–û–Ø–ù–ò–ï ===
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        let isLoading = false;

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        document.addEventListener('DOMContentLoaded', function() {
            refreshMetrics();
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            setTimeout(() => {
                toggleAutoRefresh();
            }, 2000);
        });

        // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
        async function refreshMetrics() {
            if (isLoading) return;
            
            isLoading = true;
            showLoading(true);
            
            try {
                const response = await fetch('/api/v1/analytics/admin/metrics?admin=true');
                
                if (response.ok) {
                    const data = await response.json();
                    displayMetrics(data.data);
                    updateStatus('healthy', '–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ç—Ä–∏–∫:', error);
                displayError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
                updateStatus('error', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            } finally {
                isLoading = false;
                showLoading(false);
                updateLastRefreshTime();
            }
        }

        function displayMetrics(metrics) {
            const metricsGrid = document.getElementById('metricsGrid');
            
            metricsGrid.innerHTML = `
                <div class="metric-card metric-highlight">
                    <div class="metric-value">${metrics.new_users_today}</div>
                    <div class="metric-label">üë• –ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value">${metrics.active_users_today}</div>
                    <div class="metric-label">üî• –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value">${metrics.matches_today}</div>
                    <div class="metric-label">üíï –ú–∞—Ç—á–µ–π —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value">${metrics.paid_users_total}</div>
                    <div class="metric-label">üíé –ü–ª–∞—Ç–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value">${metrics.messages_today}</div>
                    <div class="metric-label">üí¨ –°–æ–æ–±—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-value">${metrics.total_users}</div>
                    <div class="metric-label">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                </div>
            `;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
            const cards = metricsGrid.querySelectorAll('.metric-card');
            cards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.5s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        }

        function displayError(message) {
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.innerHTML = `
                <div class="metric-card" style="grid-column: 1 / -1; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <div class="metric-label" style="color: #ef4444;">${message}</div>
                    <button class="btn btn-gold mt-20" onclick="refreshMetrics()">
                        <i class="fas fa-retry"></i>
                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                </div>
            `;
        }

        function toggleAutoRefresh() {
            const icon = document.getElementById('autoRefreshIcon');
            const text = document.getElementById('autoRefreshText');
            
            if (autoRefreshEnabled) {
                // –í—ã–∫–ª—é—á–∞–µ–º
                clearInterval(autoRefreshInterval);
                autoRefreshEnabled = false;
                icon.className = 'fas fa-clock';
                text.textContent = '–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
            } else {
                // –í–∫–ª—é—á–∞–µ–º
                autoRefreshInterval = setInterval(refreshMetrics, 60000); // –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
                autoRefreshEnabled = true;
                icon.className = 'fas fa-clock pulse-glow';
                text.textContent = '–í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ';
            }
        }

        async function downloadReport() {
            try {
                showLoading(true);
                const response = await fetch('/api/v1/analytics/admin/weekly-report?admin=true');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                    const reportContent = `
SalesMatch Pro - –ù–µ–¥–µ–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}

–ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.data.new_users}
–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.data.active_users}
–ú–∞—Ç—á–µ–π: ${data.data.total_matches}
–°–æ–æ–±—â–µ–Ω–∏–π: ${data.data.total_messages}
–ù–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫: ${data.data.new_subscriptions}

–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')}
                    `;
                    
                    const blob = new Blob([reportContent], { type: 'text/plain;charset=utf-8' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `salesmatch-report-${new Date().toISOString().split('T')[0]}.txt`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    showNotification('–û—Ç—á–µ—Ç —Å–∫–∞—á–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞');
                }
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç—á–µ—Ç–∞', 'error');
            } finally {
                showLoading(false);
            }
        }

        // === –£–¢–ò–õ–ò–¢–´ ===
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        function updateLastRefreshTime() {
            const lastUpdate = document.getElementById('lastUpdate');
            lastUpdate.textContent = `–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleTimeString('ru-RU')}`;
        }

        function showNotification(message, type) {
            // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 30px;
                right: 30px;
                background: ${type === 'success' ? 'var(--glass-background)' : 'rgba(239, 68, 68, 0.9)'};
                backdrop-filter: var(--glass-backdrop);
                border: 1px solid ${type === 'success' ? 'var(--glass-border)' : 'rgba(239, 68, 68, 0.3)'};
                color: white;
                padding: 15px 20px;
                border-radius: var(--border-radius-small);
                box-shadow: var(--shadow-neumorphic);
                z-index: 10000;
                transform: translateX(400px);
                transition: all 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                e.preventDefault();
                refreshMetrics();
            }
        });
    </script>
</body>
</html>